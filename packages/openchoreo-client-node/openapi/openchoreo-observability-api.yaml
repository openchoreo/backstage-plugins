openapi: 3.1.0
info:
  title: OpenChoreo Observer API
  description: |
    The OpenChoreo Observer API provides endpoints for querying build logs, component logs,
    traces, and metrics from components, projects, gateways, and organizations.
    It integrates with OpenSearch for logs, build logs, and traces,
    and with Prometheus for metrics.
  version: 1.0.0
  contact:
    name: OpenChoreo Team
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0.html

tags:
  - name: Logs
    description: Log retrieval endpoints
  - name: Traces
    description: Trace retrieval endpoints
  - name: Metrics
    description: Resource metrics endpoints
  - name: RCA Reports
    description: AI-powered Root Cause Analysis report retrieval endpoints
  - name: Health
    description: Health check endpoints

paths:
  /health:
    get:
      tags:
        - Health
      summary: Health check
      description: Check the health status of the observer service including OpenSearch and Prometheus connectivity
      operationId: health
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: healthy
        '503':
          description: Service is unhealthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: unhealthy
                  error:
                    type: string
                    example: 'opensearch: connection failed'

  /api/logs/build/{buildId}:
    post:
      tags:
        - Logs
      summary: Get build logs
      description: Retrieve logs for a specific build
      operationId: getBuildLogs
      parameters:
        - name: buildId
          in: path
          required: true
          description: The unique identifier of the build
          schema:
            type: string
            example: 'build-123'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BuildLogsRequest'
      responses:
        '200':
          description: Successfully retrieved build logs
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LogResponse'
        '400':
          description: Bad request - invalid parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/logs/component/{componentId}:
    post:
      tags:
        - Logs
      summary: Get component logs
      description: Retrieve logs for a specific component
      operationId: getComponentLogs
      parameters:
        - name: componentId
          in: path
          required: true
          description: The unique identifier of the component
          schema:
            type: string
            example: 'comp-123'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ComponentLogsRequest'
      responses:
        '200':
          description: Successfully retrieved component logs
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LogResponse'
        '400':
          description: Bad request - invalid parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/logs/project/{projectId}:
    post:
      tags:
        - Logs
      summary: Get project logs
      description: Retrieve logs for all components in a specific project
      operationId: getProjectLogs
      parameters:
        - name: projectId
          in: path
          required: true
          description: The unique identifier of the project
          schema:
            type: string
            example: 'proj-456'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProjectLogsRequest'
      responses:
        '200':
          description: Successfully retrieved project logs
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LogResponse'
        '400':
          description: Bad request - invalid parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/logs/gateway:
    post:
      tags:
        - Logs
      summary: Get gateway logs
      description: Retrieve logs from API gateway
      operationId: getGatewayLogs
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GatewayLogsRequest'
      responses:
        '200':
          description: Successfully retrieved gateway logs
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LogResponse'
        '400':
          description: Bad request - invalid parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/logs/org/{orgId}:
    post:
      tags:
        - Logs
      summary: Get organization logs
      description: Retrieve logs for an entire organization
      operationId: getOrganizationLogs
      parameters:
        - name: orgId
          in: path
          required: true
          description: The unique identifier of the organization
          schema:
            type: string
            example: 'org-789'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OrganizationLogsRequest'
      responses:
        '200':
          description: Successfully retrieved organization logs
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LogResponse'
        '400':
          description: Bad request - invalid parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/traces:
    post:
      tags:
        - Traces
      summary: Get traces
      description: Retrieve distributed traces
      operationId: getTraces
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TracesRequest'
      responses:
        '200':
          description: Successfully retrieved component traces
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TraceResponse'
        '400':
          description: Bad request - invalid parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/metrics/component/http:
    post:
      tags:
        - Metrics
      summary: Get component HTTP metrics
      description: Retrieve HTTP request metrics (request counts, latency percentiles) for a component as time series data
      operationId: getComponentHTTPMetrics
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MetricsRequest'
      responses:
        '200':
          description: Successfully retrieved HTTP metrics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HTTPMetricsTimeSeries'
        '400':
          description: Bad request - invalid parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/metrics/component/usage:
    post:
      tags:
        - Metrics
      summary: Get component resource metrics
      description: Retrieve resource usage metrics (CPU, memory) for a component as time series data
      operationId: getComponentResourceMetrics
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MetricsRequest'
      responses:
        '200':
          description: Successfully retrieved resource metrics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ResourceMetricsTimeSeries'
        '400':
          description: Bad request - invalid parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/rca-reports/project/{projectUid}: # TODO: Modify the RCA reports request body adding auth related parameters
    post:
      tags:
        - RCA Reports
      summary: Get RCA reports by project
      description: Retrieve AI-powered Root Cause Analysis reports for a specific project with optional filtering
      operationId: getRCAReportsByProject
      parameters:
        - name: projectUid
          in: path
          required: true
          description: The unique identifier of the project
          schema:
            type: string
            example: '8a4c5e3f-9a3b-4a9e-b1e6-2c8d409f3a7b'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProjectRCAReportsRequest'
      responses:
        '200':
          description: Successfully retrieved RCA reports
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RCAReportsResponse'
        '400':
          description: Bad request - invalid parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: RCA service not available
          content:
            text/plain:
              schema:
                type: string
                example: 'RCA service not available'

  /api/rca-reports/alert/{alertId}: # TODO: Modify the RCA report request body adding auth related parameters
    get:
      tags:
        - RCA Reports
      summary: Get single RCA report by alert
      description: Retrieve a single AI-powered Root Cause Analysis report for a specific alert. Returns the latest version by default, or a specific version if provided via query parameter.
      operationId: getRCAReportByAlert
      parameters:
        - name: alertId
          in: path
          required: true
          description: The unique identifier of the alert
          schema:
            type: string
            example: 'alert-789'
        - name: version
          in: query
          required: false
          description: Specific version number of the report to retrieve. If not provided, returns the latest version.
          schema:
            type: integer
            minimum: 1
            example: 2
      responses:
        '200':
          description: Successfully retrieved RCA report
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RCAReportDetailed'
        '404':
          description: RCA report not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: RCA service not available
          content:
            text/plain:
              schema:
                type: string
                example: 'RCA service not available'

components:
  schemas:
    BuildLogsRequest:
      type: object
      required:
        - startTime
        - endTime
        - componentName
        - projectName
        - namespaceName
      properties:
        startTime:
          type: string
          format: date-time
          description: Start time for log query in RFC3339 format
          example: '2025-01-10T00:00:00Z'
        endTime:
          type: string
          format: date-time
          description: End time for log query in RFC3339 format
          example: '2025-01-10T23:59:59Z'
        limit:
          type: integer
          description: Maximum number of log entries to return
          default: 100
          minimum: 1
          maximum: 10000
          example: 100
        sortOrder:
          type: string
          description: Sort order for logs (build logs are sorted in ascending order by default)
          enum: [asc, desc]
          default: asc
          example: 'asc'
        componentName:
          type: string
          description: Component name
          example: 'my-component'
        projectName:
          type: string
          description: Project name
          example: 'my-project'
        namespaceName:
          type: string
          description: Namespace name
          example: 'my-namespace'

    ComponentLogsRequest:
      type: object
      required:
        - startTime
        - endTime
        - environmentId
        - componentName
        - projectName
        - namespaceName
        - environmentName
        # - namespace
      properties:
        startTime:
          type: string
          format: date-time
          description: Start time for log query in RFC3339 format
          example: '2025-01-10T00:00:00Z'
        endTime:
          type: string
          format: date-time
          description: End time for log query in RFC3339 format
          example: '2025-01-10T23:59:59Z'
        environmentId:
          type: string
          description: Environment identifier
          example: 'env-dev'
        namespace:
          type: string
          description: Kubernetes namespace
          example: 'default'
        searchPhrase:
          type: string
          description: Search phrase to filter logs
          example: 'error'
        logLevels:
          type: array
          items:
            type: string
          description: Filter by log levels
          example: ['ERROR', 'WARN']
        versions:
          type: array
          items:
            type: string
          description: Component versions to filter
          example: ['v1.0.0', 'v1.0.1']
        versionIds:
          type: array
          items:
            type: string
          description: Version IDs to filter
          example: ['ver-123', 'ver-456']
        limit:
          type: integer
          description: Maximum number of log entries to return
          default: 100
          minimum: 1
          maximum: 10000
          example: 100
        sortOrder:
          type: string
          description: Sort order for logs
          enum: [asc, desc]
          default: desc
          example: 'desc'
        logType:
          type: string
          description: Type of logs to retrieve
          enum: [runtime, build]
          example: 'runtime'
        buildId:
          type: string
          description: Build ID for build logs
          example: 'build-123'
        buildUuid:
          type: string
          description: Build UUID for build logs
          example: '550e8400-e29b-41d4-a716-446655440000'
        componentName:
          type: string
          description: Component name
          example: 'my-component'
        projectName:
          type: string
          description: Project name
          example: 'my-project'
        environmentName:
          type: string
          description: Environment name
          example: 'my-environment'
        namespaceName:
          type: string
          description: Namespace name
          example: 'my-namespace'

    ProjectLogsRequest:
      allOf:
        - $ref: '#/components/schemas/ComponentLogsRequest'
        - type: object
          properties:
            componentIds:
              type: array
              items:
                type: string
              description: Filter logs by specific component IDs
              example: ['comp-123', 'comp-456']

    GatewayLogsRequest:
      type: object
      required:
        - startTime
        - endTime
        - organizationId
      properties:
        startTime:
          type: string
          format: date-time
          description: Start time for log query in RFC3339 format
          example: '2025-01-10T00:00:00Z'
        endTime:
          type: string
          format: date-time
          description: End time for log query in RFC3339 format
          example: '2025-01-10T23:59:59Z'
        organizationId:
          type: string
          description: Organization identifier
          example: 'org-789'
        searchPhrase:
          type: string
          description: Search phrase to filter logs
          example: 'error'
        apiIdToVersionMap:
          type: object
          additionalProperties:
            type: string
          description: Map of API IDs to their versions
          example:
            api-123: 'v1'
            api-456: 'v2'
        gatewayVHosts:
          type: array
          items:
            type: string
          description: Gateway virtual hosts to filter
          example: ['api.example.com', 'gateway.example.com']
        limit:
          type: integer
          description: Maximum number of log entries to return
          default: 100
          minimum: 1
          maximum: 10000
          example: 100
        sortOrder:
          type: string
          description: Sort order for logs
          enum: [asc, desc]
          default: desc
          example: 'desc'
        logType:
          type: string
          description: Type of logs to retrieve
          enum: [runtime, build]
          example: 'runtime'

    OrganizationLogsRequest:
      allOf:
        - $ref: '#/components/schemas/ComponentLogsRequest'
        - type: object
          properties:
            podLabels:
              type: object
              additionalProperties:
                type: string
              description: Kubernetes pod labels to filter logs
              example:
                app: 'myapp'
                tier: 'backend'

    TracesRequest:
      type: object
      required:
        - projectUid
        - startTime
        - endTime
        - projectName
        - environmentName
        - componentNames
        - namespaceName
      properties:
        projectUid:
          type: string
          format: uuid
          description: Project UID (required)
          example: '1c4e7a9b-3f6d-4e2a-8b5c-7d9f1e3a4c6b'
        componentUids:
          type: array
          items:
            type: string
            format: uuid
          description: Array of component UIDs to filter traces (optional)
          example:
            [
              '8a4c5e2f-9d3b-4a7e-b1f6-2c8d4e9f3a7b',
              '3f7b9e1a-4c6d-4e8f-a2b5-7d1c3e8f4a9b',
            ]
        environmentUid:
          type: string
          format: uuid
          description: Environment UID to filter traces (optional)
          example: '2f5a8c1e-7d9b-4e3f-6a4c-8e1f2d7a9b5c'
        traceId:
          type: string
          description: |
            Trace ID to filter by (optional). Supports wildcard characters:
            - `*` matches zero or more characters
            - `?` matches exactly one character

            Examples:
            - Exact match: `63d7c3065ab25375e6c5d6bb135a77db`
            - Prefix match: `63d7c3065ab2537*`
            - Suffix match: `*135a77db`
            - Single char wildcard: `63d7c3065ab2537?e6c5d6bb135a77db`
          pattern: '^[a-fA-F0-9*?]+$'
          example: '63d7c3065ab25375*'
        startTime:
          type: string
          format: date-time
          description: Start time for trace query in RFC3339 format (required)
          example: '2025-01-10T00:00:00Z'
        endTime:
          type: string
          format: date-time
          description: End time for trace query in RFC3339 format (required)
          example: '2025-01-10T23:59:59Z'
        limit:
          type: integer
          description: Maximum number of traces to return
          default: 100
          minimum: 1
          maximum: 10000
          example: 100
        sortOrder:
          type: string
          description: Sort order for traces
          enum: [asc, desc]
          default: desc
          example: 'desc'
        componentNames:
          type: array
          items:
            type: string
          description: Component names to filter traces
          example: ['my-component', 'my-component-2']
        projectName:
          type: string
          description: Project name
          example: 'my-project'
        environmentName:
          type: string
          description: Environment name
          example: 'my-environment'
        namespaceName:
          type: string
          description: Namespace name
          example: 'my-namespace'

    MetricsRequest:
      type: object
      required:
        - componentId
        - environmentId
        - projectId
        - componentName
        - projectName
        - namespaceName
        - environmentName
      properties:
        componentId:
          type: string
          description: Component identifier
          example: 'comp-123'
        environmentId:
          type: string
          description: Environment identifier
          example: 'env-dev'
        projectId:
          type: string
          description: Project identifier
          example: 'proj-456'
        startTime:
          type: string
          format: date-time
          description: Start time for metrics query in RFC3339 format
          example: '2025-01-10T00:00:00Z'
        endTime:
          type: string
          format: date-time
          description: End time for metrics query in RFC3339 format
          example: '2025-01-10T23:59:59Z'
        componentName:
          type: string
          description: Component name
          example: 'my-component'
        projectName:
          type: string
          description: Project name
          example: 'my-project'
        environmentName:
          type: string
          description: Environment name
          example: 'my-environment'
        namespaceName:
          type: string
          description: Namespace name
          example: 'my-namespace'

    LogEntry:
      type: object
      properties:
        timestamp:
          type: string
          format: date-time
          description: Timestamp of the log entry
          example: '2025-01-10T12:34:56.789Z'
        log:
          type: string
          description: The actual log message
          example: 'Request processed successfully'
        level:
          type: string
          description: Log level
          example: 'INFO'
        stream:
          type: string
          description: Log stream (stdout/stderr)
          example: 'stdout'
        kubernetes:
          type: object
          description: Kubernetes metadata
          additionalProperties: true

    LogResponse:
      type: object
      properties:
        logs:
          type: array
          items:
            $ref: '#/components/schemas/LogEntry'
          description: Array of log entries
        totalCount:
          type: integer
          description: Total number of matching logs
          example: 1234
        tookMs:
          type: integer
          description: Query execution time in milliseconds
          example: 42

    TraceResponse:
      type: object
      properties:
        traces:
          type: array
          items:
            $ref: '#/components/schemas/Trace'
          description: Array of traces with their spans
        tookMs:
          type: integer
          description: Query execution time in milliseconds
          example: 15
      example:
        traces:
          - traceId: 'f3a7b9e1c4d2f5a8b6e3c9f1d4a7e2b8'
            spans:
              - spanId: 'ad3537e3f48207d0'
                name: 'lets-go'
                durationNanoseconds: 12300000
                startTime: '2025-12-03T09:16:56.84456548Z'
                endTime: '2025-12-03T09:16:56.84468848Z'
                parentSpanId: ''
                openchoreoComponentUid: '8a4c5e2f-9d3b-4a7e-b1f6-2c8d4e9f3a7b'
                openchoreoProjectUid: '1c4e7a9b-3f6d-4e2a-8b5c-7d9f1e3a4c6b'
        tookMs: 15

    Trace:
      type: object
      properties:
        traceId:
          type: string
          description: Unique trace identifier (32 hexadecimal characters)
          pattern: '^[a-fA-F0-9]{32}$'
          example: 'f3a7b9e1c4d2f5a8b6e3c9f1d4a7e2b8'
        spans:
          type: array
          items:
            $ref: '#/components/schemas/Span'
          description: Array of spans belonging to this trace

    Span:
      type: object
      properties:
        spanId:
          type: string
          description: Unique span identifier (16 hex characters)
          pattern: '^[a-f0-9]{16}$'
          example: 'ad3537e3f48207d0'
        name:
          type: string
          description: Span name/operation
          example: 'database-query'
        durationNanoseconds:
          type: integer
          format: int64
          description: Span duration in nanoseconds (calculated from endTime - startTime)
          example: 101018208
        startTime:
          type: string
          format: date-time
          description: Span start time in RFC3339Nano format
          example: '2025-10-28T11:13:56.484388Z'
        endTime:
          type: string
          format: date-time
          description: Span end time in RFC3339Nano format
          example: '2025-10-28T11:13:56.585406208Z'
        parentSpanId:
          type: string
          description: Parent span identifier (empty if root span)
          pattern: '^[a-f0-9]{0,16}$'
          example: 'b72e731db5edfd1d'
        openchoreoComponentUid:
          type: string
          format: uuid
          description: OpenChoreo component UID from resource attributes
          example: '8a4c5e2f-9d3b-4a7e-b1f6-2c8d4e9f3a7b'
        openchoreoProjectUid:
          type: string
          format: uuid
          description: OpenChoreo project UID from resource attributes
          example: '1c4e7a9b-3f6d-4e2a-8b5c-7d9f1e3a4c6b'

    TimeValuePoint:
      type: object
      properties:
        time:
          type: string
          format: date-time
          description: Timestamp in ISO 8601 format
          example: '2025-01-10T12:00:00Z'
        value:
          type: number
          format: double
          description: Metric value at this timestamp
          example: 0.75

    ResourceMetricsTimeSeries:
      type: object
      properties:
        cpuUsage:
          type: array
          items:
            $ref: '#/components/schemas/TimeValuePoint'
          description: CPU usage time series (in cores)
        cpuRequests:
          type: array
          items:
            $ref: '#/components/schemas/TimeValuePoint'
          description: CPU requests time series (in cores)
        cpuLimits:
          type: array
          items:
            $ref: '#/components/schemas/TimeValuePoint'
          description: CPU limits time series (in cores)
        memory:
          type: array
          items:
            $ref: '#/components/schemas/TimeValuePoint'
          description: Memory usage time series (in bytes)
        memoryRequests:
          type: array
          items:
            $ref: '#/components/schemas/TimeValuePoint'
          description: Memory requests time series (in bytes)
        memoryLimits:
          type: array
          items:
            $ref: '#/components/schemas/TimeValuePoint'
          description: Memory limits time series (in bytes)
      example:
        cpuUsage:
          - time: '2025-01-10T12:00:00Z'
            value: 0.25
          - time: '2025-01-10T12:05:00Z'
            value: 0.30
        cpuRequests:
          - time: '2025-01-10T12:00:00Z'
            value: 0.5
          - time: '2025-01-10T12:05:00Z'
            value: 0.5
        cpuLimits:
          - time: '2025-01-10T12:00:00Z'
            value: 1.0
          - time: '2025-01-10T12:05:00Z'
            value: 1.0
        memory:
          - time: '2025-01-10T12:00:00Z'
            value: 536870912
          - time: '2025-01-10T12:05:00Z'
            value: 549453824
        memoryRequests:
          - time: '2025-01-10T12:00:00Z'
            value: 1073741824
          - time: '2025-01-10T12:05:00Z'
            value: 1073741824
        memoryLimits:
          - time: '2025-01-10T12:00:00Z'
            value: 2147483648
          - time: '2025-01-10T12:05:00Z'
            value: 2147483648

    HTTPMetricsTimeSeries:
      type: object
      properties:
        requestCount:
          type: array
          items:
            $ref: '#/components/schemas/TimeValuePoint'
          description: Total HTTP request count time series (requests per second)
        successfulRequestCount:
          type: array
          items:
            $ref: '#/components/schemas/TimeValuePoint'
          description: Successful HTTP request count time series (status 200, requests per second)
        unsuccessfulRequestCount:
          type: array
          items:
            $ref: '#/components/schemas/TimeValuePoint'
          description: Unsuccessful HTTP request count time series (status != 200, requests per second)
        meanLatency:
          type: array
          items:
            $ref: '#/components/schemas/TimeValuePoint'
          description: Mean HTTP request latency time series (in seconds)
        latencyPercentile50th:
          type: array
          items:
            $ref: '#/components/schemas/TimeValuePoint'
          description: 50th percentile (median) HTTP request latency time series (in seconds)
        latencyPercentile90th:
          type: array
          items:
            $ref: '#/components/schemas/TimeValuePoint'
          description: 90th percentile HTTP request latency time series (in seconds)
        latencyPercentile99th:
          type: array
          items:
            $ref: '#/components/schemas/TimeValuePoint'
          description: 99th percentile HTTP request latency time series (in seconds)
      example:
        requestCount:
          - time: '2025-01-10T12:00:00Z'
            value: 125.5
          - time: '2025-01-10T12:05:00Z'
            value: 143.2
        successfulRequestCount:
          - time: '2025-01-10T12:00:00Z'
            value: 120.0
          - time: '2025-01-10T12:05:00Z'
            value: 138.5
        unsuccessfulRequestCount:
          - time: '2025-01-10T12:00:00Z'
            value: 5.5
          - time: '2025-01-10T12:05:00Z'
            value: 4.7
        meanLatency:
          - time: '2025-01-10T12:00:00Z'
            value: 0.125
          - time: '2025-01-10T12:05:00Z'
            value: 0.132
        latencyPercentile50th:
          - time: '2025-01-10T12:00:00Z'
            value: 0.095
          - time: '2025-01-10T12:05:00Z'
            value: 0.102
        latencyPercentile90th:
          - time: '2025-01-10T12:00:00Z'
            value: 0.250
          - time: '2025-01-10T12:05:00Z'
            value: 0.265
        latencyPercentile99th:
          - time: '2025-01-10T12:00:00Z'
            value: 0.500
          - time: '2025-01-10T12:05:00Z'
            value: 0.520

    ErrorResponse:
      type: object
      required:
        - error
        - code
        - message
      properties:
        error:
          type: string
          description: Error type
          enum:
            - missingParameter
            - invalidRequest
            - internalError
          example: 'invalidRequest'
        code:
          type: string
          description: Error code
          example: 'OBS-L-12'
        message:
          type: string
          description: Human-readable error message
          example: 'Invalid request format'

    ProjectRCAReportsRequest:
      type: object
      required:
        - startTime
        - endTime
        - environmentUid
      properties:
        componentUids:
          type: array
          items:
            type: string
            format: uuid
          description: Array of component UIDs to filter reports (optional)
          example:
            [
              '8a4c5e2f-9d3b-4a7e-b1f6-2c8d4e9f3a7b',
              '3f7b9e1a-4c6d-4e8f-a2b5-7d1c3e8f4a9b',
            ]
        environmentUid:
          type: string
          format: uuid
          description: Environment UID to filter reports
          example: '2f5a8c1e-7d9b-4e3f-6a4c-8e1f2d7a9b5c'
        startTime:
          type: string
          format: date-time
          description: Start time for report query in RFC3339 format
          example: '2025-01-10T00:00:00Z'
        endTime:
          type: string
          format: date-time
          description: End time for report query in RFC3339 format
          example: '2025-01-10T23:59:59Z'
        status:
          type: string
          description: Filter by report status (optional)
          enum: [pending, completed, failed]
          example: 'completed'
        limit:
          type: integer
          description: Maximum number of reports to return
          default: 100
          minimum: 1
          maximum: 10000
          example: 100

    RCAReportSummary:
      type: object
      properties:
        alertId:
          type: string
          description: Alert identifier
          example: 'alert-789'
        projectUid:
          type: string
          format: uuid
          description: Project UID
          example: '1c4e7a9b-3f6d-4e2a-8b5c-7d9f1e3a4c6b'
        reportId:
          type: string
          description: Report identifier
          example: 'report-456'
        timestamp:
          type: string
          format: date-time
          description: Report generation timestamp
          example: '2025-01-10T12:34:56.789Z'
        summary:
          type: string
          description: Brief summary of the RCA report
          example: 'High CPU usage detected in authentication service'
        status:
          type: string
          description: Report generation status
          enum: [pending, completed, failed]
          example: 'completed'

    RCAReportsResponse:
      type: object
      properties:
        reports:
          type: array
          items:
            $ref: '#/components/schemas/RCAReportSummary'
          description: Array of RCA report summaries
        totalCount:
          type: integer
          description: Total number of matching reports
          example: 42
        tookMs:
          type: integer
          description: Query execution time in milliseconds
          example: 15

    RCAReportDetailed:
      type: object
      description: Full AI-powered Root Cause Analysis report with version information
      additionalProperties: true
      properties:
        alertId:
          type: string
          description: Alert identifier
          example: 'alert-789'
        projectUid:
          type: string
          format: uuid
          description: Project UID
          example: '1c4e7a9b-3f6d-4e2a-8b5c-7d9f1e3a4c6b'
        reportVersion:
          type: integer
          description: The version number of the report being returned
          example: 2
        reportId:
          type: string
          description: Report identifier for this version
          example: 'report-456'
        timestamp:
          type: string
          format: date-time
          description: Report generation timestamp for this version
          example: '2025-01-10T12:34:56.789Z'
        status:
          type: string
          description: Report generation status for this version
          enum: [pending, completed, failed]
          example: 'completed'
        availableVersions:
          type: array
          items:
            type: integer
          description: List of all available version numbers for this alert (sorted descending, latest first)
          example: [2, 1]
        report:
          $ref: '#/components/schemas/RCAReport'
          description: The complete Root Cause Analysis report content

    RCAReport:
      type: object
      description: Complete Root Cause Analysis Report for OpenChoreo incidents
      required:
        - alert_context
        - summary
        - result
        - investigation_path
      properties:
        alert_context:
          $ref: '#/components/schemas/ReportAlertContext'
          description: The alert that triggered this RCA
        summary:
          type: string
          description: Concise summary of the investigation outcome (1 sentence)
          example: 'Database connection pool exhaustion caused analytics service errors. RCA identified memory leak in connection handling.'
        result:
          description: The RCA result - either root causes identified, or explanation of why not
          discriminator:
            propertyName: type
            mapping:
              root_cause_identified: '#/components/schemas/RootCauseIdentified'
              no_root_cause_identified: '#/components/schemas/NoRootCauseIdentified'
          oneOf:
            - $ref: '#/components/schemas/RootCauseIdentified'
            - $ref: '#/components/schemas/NoRootCauseIdentified'
        investigation_path:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/InvestigationStep'
          description: Sequential steps the agent took during investigation

    AlertCondition:
      type: object
      description: Structured alert condition that triggered the alert
      required:
        - window
        - interval
        - operator
        - threshold
      properties:
        window:
          type: string
          description: Time window for the condition
          example: '5m'
        interval:
          type: string
          description: Evaluation interval
          example: '1m'
        operator:
          type: string
          description: Comparison operator
          example: '>'
        threshold:
          type: integer
          description: Threshold value that was exceeded
          example: 2000

    ReportAlertContext:
      type: object
      description: Context about the alert that triggered this RCA
      required:
        - alert_id
        - alert_name
        - triggered_at
        - trigger_value
        - condition
        - component_uid
        - project_uid
        - environment_uid
      properties:
        alert_id:
          type: string
          description: Unique identifier of the alert
          example: 'alert-12345'
        alert_name:
          type: string
          description: Name of the alert rule
          example: 'High Error Rate'
        alert_description:
          type: string
          nullable: true
          description: Optional description of the alert
          example: 'Triggers when error rate exceeds threshold'
        severity:
          type: string
          nullable: true
          description: Alert severity level
          example: 'critical'
        namespace:
          type: string
          nullable: true
          description: Kubernetes namespace
          example: 'production'
        triggered_at:
          type: string
          format: date-time
          description: ISO timestamp when alert fired
          example: '2025-01-10T08:15:00Z'
        trigger_value:
          type: number
          description: The value that triggered the alert
          example: 47
        source_type:
          type: string
          nullable: true
          description: Alert source type (log, metric)
          example: 'metric'
        source_query:
          type: string
          nullable: true
          description: The query used to detect the alert condition
          example: 'sum(rate(http_errors_total[5m])) > 10'
        source_metric:
          type: string
          nullable: true
          description: The metric name if source type is metric
          example: 'http_request_duration_seconds'
        condition:
          $ref: '#/components/schemas/AlertCondition'
        component_uid:
          type: string
          description: Component UID this alert relates to
          example: '8a4c5e2f-9d3b-4a7e-b1f6-2c8d4e9f3a7b'
        project_uid:
          type: string
          description: Project UID this alert relates to
          example: '1c4e7a9b-3f6d-4e2a-8b5c-7d9f1e3a4c6b'
        environment_uid:
          type: string
          description: Environment UID
          example: 'e1a7f0fd-f4d7-4d76-80c1-1dabba9d95db'

    RootCauseIdentified:
      type: object
      description: RCA was performed and root causes were identified
      required:
        - root_causes
        - timeline
        - recommendations
      properties:
        type:
          type: string
          enum: [root_cause_identified]
          default: root_cause_identified
          description: Discriminator value for root cause identified result
        root_causes:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/RootCause'
          description: Identified root causes in order of significance. Each contains its own supporting findings.
        timeline:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/TimelineEvent'
          description: Chronological sequence of significant system events discovered through analysis
        excluded_causes:
          type: array
          items:
            $ref: '#/components/schemas/ExcludedCause'
          description: Potential causes that were investigated and ruled out with reasoning, helping narrow down the actual root cause.
        recommendations:
          $ref: '#/components/schemas/Recommendations'

    NoRootCauseIdentified:
      type: object
      description: RCA was performed but no root cause was identified
      required:
        - outcome
        - explanation
      properties:
        type:
          type: string
          enum: [no_root_cause_identified]
          default: no_root_cause_identified
          description: Discriminator value for no root cause identified result
        outcome:
          $ref: '#/components/schemas/NoRootCauseOutcome'
        explanation:
          type: string
          description: Detailed explanation of why no root cause was identified
          example: 'The alert appears to be a false positive. System metrics remained within normal parameters throughout the time period.'
        recommendations:
          nullable: true
          allOf:
            - $ref: '#/components/schemas/Recommendations'
          description: Recommendations for improving tracing, observability, monitoring, or alerting to enable better RCA in the future

    NoRootCauseOutcome:
      type: string
      description: Categorized outcome when no root cause is identified
      enum:
        - no_anomaly_detected
        - insufficient_data
        - transient
        - external_dependency

    RootCause:
      type: object
      description: An identified root cause with its supporting findings
      required:
        - summary
        - confidence
        - analysis
        - supporting_findings
      properties:
        summary:
          type: string
          description: Detailed description of the root cause. Be specific about what failed and why.
          example: 'Database connection pool exhausted due to connections not being properly released after query completion'
        confidence:
          $ref: '#/components/schemas/ConfidenceLevel'
        supporting_findings:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/Finding'
          description: Findings that support this root cause determination. Each finding contains an observation and evidence.
        analysis:
          type: string
          description: Explains how the findings correlate with each other and collectively support this root cause determination
          example: 'Error logs showing connection timeouts correlate with metric spikes in connection pool usage, and traces reveal slow database queries at the same timestamp'

    Finding:
      type: object
      description: A finding that supports a root cause, wrapping evidence with context
      required:
        - observation
        - component_uid
        - time_range
        - evidence
      properties:
        observation:
          type: string
          description: Human-readable summary of what was found
          example: 'Connection pool saturated'
        component_uid:
          type: string
          description: Component UID this finding relates to
          example: '8a4c5e2f-9d3b-4a7e-b1f6-2c8d4e9f3a7b'
        time_range:
          $ref: '#/components/schemas/TimeRange'
          description: Time range for deep-dive linking
        evidence:
          description: The actual evidence (log, metric, or trace)
          discriminator:
            propertyName: type
            mapping:
              log: '#/components/schemas/LogEvidence'
              metric: '#/components/schemas/MetricEvidence'
              trace: '#/components/schemas/TraceEvidence'
          oneOf:
            - $ref: '#/components/schemas/LogEvidence'
            - $ref: '#/components/schemas/MetricEvidence'
            - $ref: '#/components/schemas/TraceEvidence'

    ConfidenceLevel:
      type: string
      description: Confidence level in root cause determination
      enum:
        - high
        - medium
        - low

    LogEvidence:
      type: object
      description: Evidence from application logs showing significant issues
      required:
        - type
        - log_lines
      properties:
        type:
          type: string
          enum: [log]
          default: log
          description: Evidence type discriminator
        log_lines:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/LogLine'
          description: Relevant log lines (can be 1 or multiple related lines)
        repetition:
          type: string
          nullable: true
          description: Descriptive repetition pattern
          example: 'This error repeated 47 times over 5 minutes'

    LogLine:
      type: object
      description: A single log line within log evidence
      required:
        - timestamp
        - level
        - message
      properties:
        timestamp:
          type: string
          format: date-time
          description: ISO 8601 timestamp when log occurred
          example: '2025-01-10T08:15:23.456Z'
        level:
          $ref: '#/components/schemas/LogLevel'
        message:
          type: string
          description: The log message
          example: 'ERROR: Database connection timeout after 30s'

    MetricEvidence:
      type: object
      description: Evidence from metrics showing anomalous values
      required:
        - type
        - name
        - summary
        - severity
      properties:
        type:
          type: string
          enum: [metric]
          default: metric
          description: Evidence type discriminator
        name:
          type: string
          description: Human-readable name of the metric
          example: 'RAM usage'
        summary:
          type: string
          description: Self-contained explanation of the anomaly and its RCA relevance
          example: 'RAM usage at 95.5% exceeds 90% threshold, causing OOM kills'
        severity:
          $ref: '#/components/schemas/Severity'
        highlights:
          type: array
          items:
            $ref: '#/components/schemas/MetricHighlight'
          description: Highlighted values with severity for UI coloring

    MetricHighlight:
      type: object
      description: A highlighted metric value with severity
      required:
        - value
        - severity
      properties:
        value:
          type: string
          description: Formatted metric value with unit
          example: '95.5%'
        severity:
          $ref: '#/components/schemas/Severity'

    TraceEvidence:
      type: object
      description: Evidence from distributed traces showing request flow patterns
      required:
        - type
        - trace_id
        - span_id
        - summary
      properties:
        type:
          type: string
          enum: [trace]
          default: trace
          description: Evidence type discriminator
        trace_id:
          type: string
          description: Unique trace identifier for reference
          example: 'f3a7b9e1c4d2f5a8b6e3c9f1d4a7e2b8'
        span_id:
          type: string
          description: Specific span ID within the trace
          example: 'ad3537e3f48207d0'
        summary:
          type: string
          description: Text description of what the trace shows
          example: 'Request to /api/users took 5.2s, with 4.8s spent in database query'
        is_error:
          type: boolean
          default: false
          description: Whether this span had an error
        error_message:
          type: string
          nullable: true
          description: Error message if is_error is true
          example: 'Connection timeout'
        highlights:
          type: array
          items:
            $ref: '#/components/schemas/TraceHighlight'
          description: Highlighted values with severity for UI coloring
        repetition:
          type: string
          nullable: true
          description: Descriptive repetition pattern
          example: 'Similar slow spans seen in 23 traces'

    TraceHighlight:
      type: object
      description: A highlighted trace value with severity
      required:
        - value
        - severity
      properties:
        value:
          type: string
          description: Formatted trace value
          example: '5200ms'
        severity:
          $ref: '#/components/schemas/Severity'

    LogLevel:
      type: string
      description: Log severity levels
      enum:
        - ERROR
        - WARN
        - INFO
        - DEBUG

    Severity:
      type: string
      description: Severity level for highlighted values - used for color coding in UI
      enum:
        - critical
        - warning
        - normal

    TimeRange:
      type: object
      description: Time range for metric observations
      required:
        - start
        - end
      properties:
        start:
          type: string
          format: date-time
          description: ISO 8601 timestamp for range start
          example: '2025-01-10T08:00:00Z'
        end:
          type: string
          format: date-time
          description: ISO 8601 timestamp for range end
          example: '2025-01-10T09:00:00Z'

    ExcludedCause:
      type: object
      description: A potential cause that was investigated and ruled out
      required:
        - description
        - rationale
      properties:
        description:
          type: string
          description: The potential cause that was investigated and excluded
          example: 'Network connectivity issues'
        rationale:
          type: string
          description: Why this was ruled out as a root cause based on evidence
          example: 'Network latency metrics remained stable throughout the incident period'

    TimelineEvent:
      type: object
      description: A significant system event observed in telemetry data. Represents actual system behavior, not agent investigation actions.
      required:
        - timestamp
        - event
      properties:
        timestamp:
          type: string
          format: date-time
          description: ISO 8601 timestamp when the event occurred
          example: '2025-01-10T08:15:00Z'
        event:
          type: string
          description: Description of what happened in the system
          example: 'analytics-service started returning 500 errors'
        component_uid:
          type: string
          nullable: true
          description: Optional component UID this event relates to
          example: '8a4c5e2f-9d3b-4a7e-b1f6-2c8d4e9f3a7b'

    InvestigationStep:
      type: object
      description: A significant step the agent took during investigation
      required:
        - action
        - outcome
      properties:
        action:
          type: string
          description: What the agent investigated (e.g., 'Analyzed error logs from analytics-service')
          example: 'Analyzed error logs from analytics-service'
        rationale:
          type: string
          nullable: true
          description: Why the agent took this step (e.g., 'Previous step showed high error rate')
          example: 'Previous step showed high error rate from this component'
        outcome:
          type: string
          description: What the agent found or concluded from this step
          example: 'Found 47 database connection timeout errors between 08:15 and 08:20 UTC'

    Recommendations:
      type: object
      description: Actionable recommendations to prevent recurrence
      properties:
        recommended_actions:
          type: array
          items:
            $ref: '#/components/schemas/Action'
          description: Prioritized actions sorted by priority
        observability_recommendations:
          type: array
          items:
            $ref: '#/components/schemas/Action'
          description: Suggestions for additional monitoring, alerting, or observability improvements

    Action:
      type: object
      description: An actionable recommendation
      required:
        - description
      properties:
        description:
          type: string
          description: Description of the action to take
          example: 'Review and fix connection pooling logic to ensure connections are properly released'
        rationale:
          type: string
          nullable: true
          description: Why this action is recommended
          example: 'Will prevent connection pool exhaustion from recurring'
